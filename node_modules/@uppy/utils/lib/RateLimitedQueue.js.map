{"version":3,"names":["createCancelError","Error","RateLimitedQueue","constructor","limit","resume","setTimeout","Math","ceil","i","floor","Infinity","run","fn","queueOptions","wrapPromiseFunction","args","queuedRequest","outerPromise","Promise","resolve","reject","cancelError","innerPromise","err","then","result","done","abort","clearTimeout","pause","duration","rateLimit","Number","isFinite","isPaused","cancelActive","queueMicrotask","length","next","shift","handler","options","priority","index","findIndex","other","push","splice","indexOf","internalRateLimitedQueue","Symbol"],"sources":["RateLimitedQueue.js"],"sourcesContent":["function createCancelError () {\n  return new Error('Cancelled')\n}\n\nexport class RateLimitedQueue {\n  #activeRequests = 0\n\n  #queuedHandlers = []\n\n  #paused = false\n\n  #pauseTimer\n\n  #downLimit = 1\n\n  #upperLimit\n\n  #rateLimitingTimer\n\n  constructor (limit) {\n    if (typeof limit !== 'number' || limit === 0) {\n      this.limit = Infinity\n    } else {\n      this.limit = limit\n    }\n  }\n\n  #call (fn) {\n    this.#activeRequests += 1\n\n    let done = false\n\n    let cancelActive\n    try {\n      cancelActive = fn()\n    } catch (err) {\n      this.#activeRequests -= 1\n      throw err\n    }\n\n    return {\n      abort: () => {\n        if (done) return\n        done = true\n        this.#activeRequests -= 1\n        cancelActive()\n        this.#queueNext()\n      },\n\n      done: () => {\n        if (done) return\n        done = true\n        this.#activeRequests -= 1\n        this.#queueNext()\n      },\n    }\n  }\n\n  #queueNext () {\n    // Do it soon but not immediately, this allows clearing out the entire queue synchronously\n    // one by one without continuously _advancing_ it (and starting new tasks before immediately\n    // aborting them)\n    queueMicrotask(() => this.#next())\n  }\n\n  #next () {\n    if (this.#paused || this.#activeRequests >= this.limit) {\n      return\n    }\n    if (this.#queuedHandlers.length === 0) {\n      return\n    }\n\n    // Dispatch the next request, and update the abort/done handlers\n    // so that cancelling it does the Right Thing (and doesn't just try\n    // to dequeue an already-running request).\n    const next = this.#queuedHandlers.shift()\n    const handler = this.#call(next.fn)\n    next.abort = handler.abort\n    next.done = handler.done\n  }\n\n  #queue (fn, options = {}) {\n    const handler = {\n      fn,\n      priority: options.priority || 0,\n      abort: () => {\n        this.#dequeue(handler)\n      },\n      done: () => {\n        throw new Error('Cannot mark a queued request as done: this indicates a bug')\n      },\n    }\n\n    const index = this.#queuedHandlers.findIndex((other) => {\n      return handler.priority > other.priority\n    })\n    if (index === -1) {\n      this.#queuedHandlers.push(handler)\n    } else {\n      this.#queuedHandlers.splice(index, 0, handler)\n    }\n    return handler\n  }\n\n  #dequeue (handler) {\n    const index = this.#queuedHandlers.indexOf(handler)\n    if (index !== -1) {\n      this.#queuedHandlers.splice(index, 1)\n    }\n  }\n\n  run (fn, queueOptions) {\n    if (!this.#paused && this.#activeRequests < this.limit) {\n      return this.#call(fn)\n    }\n    return this.#queue(fn, queueOptions)\n  }\n\n  wrapPromiseFunction (fn, queueOptions) {\n    return (...args) => {\n      let queuedRequest\n      const outerPromise = new Promise((resolve, reject) => {\n        queuedRequest = this.run(() => {\n          let cancelError\n          let innerPromise\n          try {\n            innerPromise = Promise.resolve(fn(...args))\n          } catch (err) {\n            innerPromise = Promise.reject(err)\n          }\n\n          innerPromise.then((result) => {\n            if (cancelError) {\n              reject(cancelError)\n            } else {\n              queuedRequest.done()\n              resolve(result)\n            }\n          }, (err) => {\n            if (cancelError) {\n              reject(cancelError)\n            } else {\n              queuedRequest.done()\n              reject(err)\n            }\n          })\n\n          return () => {\n            cancelError = createCancelError()\n          }\n        }, queueOptions)\n      })\n\n      outerPromise.abort = () => {\n        queuedRequest.abort()\n      }\n\n      return outerPromise\n    }\n  }\n\n  resume () {\n    this.#paused = false\n    clearTimeout(this.#pauseTimer)\n    for (let i = 0; i < this.limit; i++) {\n      this.#queueNext()\n    }\n  }\n\n  #resume = () => this.resume()\n\n  /**\n   * Freezes the queue for a while or indefinitely.\n   *\n   * @param {number | null } [duration] Duration for the pause to happen, in milliseconds.\n   *                                    If omitted, the queue won't resume automatically.\n   */\n  pause (duration = null) {\n    this.#paused = true\n    clearTimeout(this.#pauseTimer)\n    if (duration != null) {\n      this.#pauseTimer = setTimeout(this.#resume, duration)\n    }\n  }\n\n  /**\n   * Pauses the queue for a duration, and lower the limit of concurrent requests\n   * when the queue resumes. When the queue resumes, it tries to progressively\n   * increase the limit in `this.#increaseLimit` until another call is made to\n   * `this.rateLimit`.\n   * Call this function when using the RateLimitedQueue for network requests and\n   * the remote server responds with 429 HTTP code.\n   *\n   * @param {number} duration in milliseconds.\n   */\n  rateLimit (duration) {\n    clearTimeout(this.#rateLimitingTimer)\n    this.pause(duration)\n    if (this.limit > 1 && Number.isFinite(this.limit)) {\n      this.#upperLimit = this.limit - 1\n      this.limit = this.#downLimit\n      this.#rateLimitingTimer = setTimeout(this.#increaseLimit, duration)\n    }\n  }\n\n  #increaseLimit = () => {\n    if (this.#paused) {\n      this.#rateLimitingTimer = setTimeout(this.#increaseLimit, 0)\n      return\n    }\n    this.#downLimit = this.limit\n    this.limit = Math.ceil((this.#upperLimit + this.#downLimit) / 2)\n    for (let i = this.#downLimit; i <= this.limit; i++) {\n      this.#queueNext()\n    }\n    if (this.#upperLimit - this.#downLimit > 3) {\n      this.#rateLimitingTimer = setTimeout(this.#increaseLimit, 2000)\n    } else {\n      this.#downLimit = Math.floor(this.#downLimit / 2)\n    }\n  }\n\n  get isPaused () { return this.#paused }\n}\n\nexport const internalRateLimitedQueue = Symbol('__queue')\n"],"mappings":"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"}