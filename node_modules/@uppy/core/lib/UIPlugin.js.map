{"version":3,"names":["render","findDOMElement","getTextDirection","BasePlugin","debounce","fn","calling","latestArgs","args","Promise","resolve","then","UIPlugin","mount","target","plugin","callerPluginName","id","targetElement","isTargetDOMEl","uppyRootElement","document","createElement","classList","add","state","uppy","getPlugin","afterUpdate","log","opts","replaceTargetContent","innerHTML","getState","el","appendChild","dir","direction","onMount","targetPlugin","Target","iteratePlugins","p","parent","addTarget","message","Error","update","unmount","remove","onUnmount"],"sources":["UIPlugin.js"],"sourcesContent":["import { render } from 'preact'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport getTextDirection from '@uppy/utils/lib/getTextDirection'\n\nimport BasePlugin from './BasePlugin.js'\n\n/**\n * Defer a frequent call to the microtask queue.\n *\n * @param {() => T} fn\n * @returns {Promise<T>}\n */\nfunction debounce (fn) {\n  let calling = null\n  let latestArgs = null\n  return (...args) => {\n    latestArgs = args\n    if (!calling) {\n      calling = Promise.resolve().then(() => {\n        calling = null\n        // At this point `args` may be different from the most\n        // recent state, if multiple calls happened since this task\n        // was queued. So we use the `latestArgs`, which definitely\n        // is the most recent call.\n        return fn(...latestArgs)\n      })\n    }\n    return calling\n  }\n}\n\n/**\n * UIPlugin is the extended version of BasePlugin to incorporate rendering with Preact.\n * Use this for plugins that need a user interface.\n *\n * For plugins without an user interface, see BasePlugin.\n */\nclass UIPlugin extends BasePlugin {\n  #updateUI\n\n  /**\n   * Check if supplied `target` is a DOM element or an `object`.\n   * If it’s an object — target is a plugin, and we search `plugins`\n   * for a plugin with same name and return its target.\n   */\n  mount (target, plugin) {\n    const callerPluginName = plugin.id\n\n    const targetElement = findDOMElement(target)\n\n    if (targetElement) {\n      this.isTargetDOMEl = true\n      // When target is <body> with a single <div> element,\n      // Preact thinks it’s the Uppy root element in there when doing a diff,\n      // and destroys it. So we are creating a fragment (could be empty div)\n      const uppyRootElement = document.createElement('div')\n      uppyRootElement.classList.add('uppy-Root')\n\n      // API for plugins that require a synchronous rerender.\n      this.#updateUI = debounce((state) => {\n        // plugin could be removed, but this.rerender is debounced below,\n        // so it could still be called even after uppy.removePlugin or uppy.close\n        // hence the check\n        if (!this.uppy.getPlugin(this.id)) return\n        render(this.render(state), uppyRootElement)\n        this.afterUpdate()\n      })\n\n      this.uppy.log(`Installing ${callerPluginName} to a DOM element '${target}'`)\n\n      if (this.opts.replaceTargetContent) {\n        // Doing render(h(null), targetElement), which should have been\n        // a better way, since because the component might need to do additional cleanup when it is removed,\n        // stopped working — Preact just adds null into target, not replacing\n        targetElement.innerHTML = ''\n      }\n\n      render(this.render(this.uppy.getState()), uppyRootElement)\n      this.el = uppyRootElement\n      targetElement.appendChild(uppyRootElement)\n\n      // Set the text direction if the page has not defined one.\n      uppyRootElement.dir = this.opts.direction || getTextDirection(uppyRootElement) || 'ltr'\n\n      this.onMount()\n\n      return this.el\n    }\n\n    let targetPlugin\n    if (typeof target === 'object' && target instanceof UIPlugin) {\n      // Targeting a plugin *instance*\n      targetPlugin = target\n    } else if (typeof target === 'function') {\n      // Targeting a plugin type\n      const Target = target\n      // Find the target plugin instance.\n      this.uppy.iteratePlugins(p => {\n        if (p instanceof Target) {\n          targetPlugin = p\n        }\n      })\n    }\n\n    if (targetPlugin) {\n      this.uppy.log(`Installing ${callerPluginName} to ${targetPlugin.id}`)\n      this.parent = targetPlugin\n      this.el = targetPlugin.addTarget(plugin)\n\n      this.onMount()\n      return this.el\n    }\n\n    this.uppy.log(`Not installing ${callerPluginName}`)\n\n    let message = `Invalid target option given to ${callerPluginName}.`\n    if (typeof target === 'function') {\n      message += ' The given target is not a Plugin class. '\n        + 'Please check that you\\'re not specifying a React Component instead of a plugin. '\n        + 'If you are using @uppy/* packages directly, make sure you have only 1 version of @uppy/core installed: '\n        + 'run `npm ls @uppy/core` on the command line and verify that all the versions match and are deduped correctly.'\n    } else {\n      message += 'If you meant to target an HTML element, please make sure that the element exists. '\n        + 'Check that the <script> tag initializing Uppy is right before the closing </body> tag at the end of the page. '\n        + '(see https://github.com/transloadit/uppy/issues/1042)\\n\\n'\n        + 'If you meant to target a plugin, please confirm that your `import` statements or `require` calls are correct.'\n    }\n    throw new Error(message)\n  }\n\n  update (state) {\n    if (this.el != null) {\n      this.#updateUI?.(state)\n    }\n  }\n\n  unmount () {\n    if (this.isTargetDOMEl) {\n      this.el?.remove()\n    }\n    this.onUnmount()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  onMount () {}\n\n  // eslint-disable-next-line class-methods-use-this\n  onUnmount () {}\n}\n\nexport default UIPlugin\n"],"mappings":"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"}