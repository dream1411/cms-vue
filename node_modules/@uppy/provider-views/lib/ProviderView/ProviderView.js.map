{"version":3,"names":["h","AuthView","Header","Browser","LoaderView","CloseWrapper","View","packageJson","getOrigin","location","origin","getRegex","value","RegExp","undefined","isOriginAllowed","allowedOrigin","patterns","Array","isArray","map","some","pattern","test","ProviderView","constructor","plugin","opts","defaultOptions","viewType","showTitles","showFilter","showBreadcrumbs","filterQuery","bind","getFolder","getNextFolder","logout","handleAuth","handleScroll","listAllFiles","donePicking","render","setPluginState","authenticated","files","folders","directories","filterInput","isSearchVisible","currentSelection","tearDown","id","name","sharedHandler","loaderWrapper","provider","list","res","updatedDirectories","state","getPluginState","index","findIndex","dir","slice","concat","title","username","handleError","folder","requestPath","lastCheckbox","then","ok","revoked","message","uppy","i18n","url","manual_revoke_url","info","newState","catch","e","target","addFolder","folderId","providerFileToId","selectedFolders","loading","count","forEach","file","checkIfFileAlreadyExists","addFile","ids","length","smart_count","ensurePreAuth","authState","btoa","JSON","stringify","clientVersion","VERSION","link","authUrl","uppyVersions","authWindow","window","open","handleToken","source","log","companionAllowedHosts","data","parse","error","token","close","removeEventListener","setAuthToken","preFirstRender","addEventListener","event","path","nextPagePath","shouldHandleScroll","isHandlingScroll","response","items","item","isFolder","push","moreFiles","promises","Promise","all","clearSelection","viewOptions","didFirstRender","targetViewOptions","isChecked","toggleCheckbox","recordShiftKeyPress","filterItems","hasInput","headerProps","pluginIcon","icon","browserProps","done","cancel","cancelPicking","headerComponent","uppyFiles","getFiles","validateRestrictions","i18nArray","version"],"sources":["ProviderView.jsx"],"sourcesContent":["import { h } from 'preact'\n\nimport AuthView from './AuthView.jsx'\nimport Header from './Header.jsx'\nimport Browser from '../Browser.jsx'\nimport LoaderView from '../Loader.jsx'\nimport CloseWrapper from '../CloseWrapper.js'\nimport View from '../View.js'\n\nimport packageJson from '../../package.json'\n\nfunction getOrigin () {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nfunction getRegex (value) {\n  if (typeof value === 'string') {\n    return new RegExp(`^${value}$`)\n  } if (value instanceof RegExp) {\n    return value\n  }\n  return undefined\n}\nfunction isOriginAllowed (origin, allowedOrigin) {\n  const patterns = Array.isArray(allowedOrigin) ? allowedOrigin.map(getRegex) : [getRegex(allowedOrigin)]\n  return patterns\n    .some((pattern) => pattern?.test(origin) || pattern?.test(`${origin}/`)) // allowing for trailing '/'\n}\n\n/**\n * Class to easily generate generic views for Provider plugins\n */\nexport default class ProviderView extends View {\n  static VERSION = packageJson.version\n\n  /**\n   * @param {object} plugin instance of the plugin\n   * @param {object} opts\n   */\n  constructor (plugin, opts) {\n    super(plugin, opts)\n    // set default options\n    const defaultOptions = {\n      viewType: 'list',\n      showTitles: true,\n      showFilter: true,\n      showBreadcrumbs: true,\n    }\n\n    // merge default options with the ones set by user\n    this.opts = { ...defaultOptions, ...opts }\n\n    // Logic\n    this.filterQuery = this.filterQuery.bind(this)\n    this.getFolder = this.getFolder.bind(this)\n    this.getNextFolder = this.getNextFolder.bind(this)\n    this.logout = this.logout.bind(this)\n    this.handleAuth = this.handleAuth.bind(this)\n    this.handleScroll = this.handleScroll.bind(this)\n    this.listAllFiles = this.listAllFiles.bind(this)\n    this.donePicking = this.donePicking.bind(this)\n\n    // Visual\n    this.render = this.render.bind(this)\n\n    // Set default state for the plugin\n    this.plugin.setPluginState({\n      authenticated: false,\n      files: [],\n      folders: [],\n      directories: [],\n      filterInput: '',\n      isSearchVisible: false,\n      currentSelection: [],\n    })\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  tearDown () {\n    // Nothing.\n  }\n\n  #updateFilesAndFolders (res, files, folders) {\n    this.nextPagePath = res.nextPagePath\n    res.items.forEach((item) => {\n      if (item.isFolder) {\n        folders.push(item)\n      } else {\n        files.push(item)\n      }\n    })\n\n    this.plugin.setPluginState({ folders, files })\n  }\n\n  /**\n   * Based on folder ID, fetch a new folder and update it to state\n   *\n   * @param  {string} id Folder id\n   * @returns {Promise}   Folders/files in folder\n   */\n  getFolder (id, name) {\n    return this.sharedHandler.loaderWrapper(\n      this.provider.list(id),\n      (res) => {\n        const folders = []\n        const files = []\n        let updatedDirectories\n\n        const state = this.plugin.getPluginState()\n        const index = state.directories.findIndex((dir) => id === dir.id)\n\n        if (index !== -1) {\n          updatedDirectories = state.directories.slice(0, index + 1)\n        } else {\n          updatedDirectories = state.directories.concat([{ id, title: name }])\n        }\n\n        this.username = res.username || this.username\n        this.#updateFilesAndFolders(res, files, folders)\n        this.plugin.setPluginState({ directories: updatedDirectories, filterInput: '' })\n      },\n      this.handleError,\n    )\n  }\n\n  /**\n   * Fetches new folder\n   *\n   * @param  {object} folder\n   */\n  getNextFolder (folder) {\n    this.getFolder(folder.requestPath, folder.name)\n    this.lastCheckbox = undefined\n  }\n\n  /**\n   * Removes session token on client side.\n   */\n  logout () {\n    this.provider.logout()\n      .then((res) => {\n        if (res.ok) {\n          if (!res.revoked) {\n            const message = this.plugin.uppy.i18n('companionUnauthorizeHint', {\n              provider: this.plugin.title,\n              url: res.manual_revoke_url,\n            })\n            this.plugin.uppy.info(message, 'info', 7000)\n          }\n\n          const newState = {\n            authenticated: false,\n            files: [],\n            folders: [],\n            directories: [],\n            filterInput: '',\n          }\n          this.plugin.setPluginState(newState)\n        }\n      }).catch(this.handleError)\n  }\n\n  filterQuery (e) {\n    const state = this.plugin.getPluginState()\n    this.plugin.setPluginState({ ...state, filterInput: e ? e.target.value : '' })\n  }\n\n  /**\n   * Adds all files found inside of specified folder.\n   *\n   * Uses separated state while folder contents are being fetched and\n   * mantains list of selected folders, which are separated from files.\n   */\n  addFolder (folder) {\n    const folderId = this.providerFileToId(folder)\n    const folders = { ...this.plugin.getPluginState().selectedFolders }\n\n    if (folderId in folders && folders[folderId].loading) {\n      return\n    }\n\n    folders[folderId] = { loading: true, files: [] }\n\n    this.plugin.setPluginState({ selectedFolders: { ...folders } })\n\n    // eslint-disable-next-line consistent-return\n    return this.listAllFiles(folder.requestPath).then((files) => {\n      let count = 0\n\n      // If the same folder is added again, we don't want to send\n      // X amount of duplicate file notifications, we want to say\n      // the folder was already added. This checks if all files are duplicate,\n      // if that's the case, we don't add the files.\n      files.forEach(file => {\n        const id = this.providerFileToId(file)\n        if (!this.plugin.uppy.checkIfFileAlreadyExists(id)) {\n          count++\n        }\n      })\n\n      if (count > 0) {\n        files.forEach((file) => this.addFile(file))\n      }\n\n      const ids = files.map(this.providerFileToId)\n\n      folders[folderId] = {\n        loading: false,\n        files: ids,\n      }\n      this.plugin.setPluginState({ selectedFolders: folders, filterInput: '' })\n\n      let message\n\n      if (count === 0) {\n        message = this.plugin.uppy.i18n('folderAlreadyAdded', {\n          folder: folder.name,\n        })\n      } else if (files.length) {\n        message = this.plugin.uppy.i18n('folderAdded', {\n          smart_count: count, folder: folder.name,\n        })\n      } else {\n        message = this.plugin.uppy.i18n('emptyFolderAdded')\n      }\n\n      this.plugin.uppy.info(message)\n    }).catch((e) => {\n      const selectedFolders = { ...this.plugin.getPluginState().selectedFolders }\n      delete selectedFolders[folderId]\n      this.plugin.setPluginState({ selectedFolders })\n      this.handleError(e)\n    })\n  }\n\n  async handleAuth () {\n    await this.provider.ensurePreAuth()\n\n    const authState = btoa(JSON.stringify({ origin: getOrigin() }))\n    const clientVersion = `@uppy/provider-views=${ProviderView.VERSION}`\n    const link = this.provider.authUrl({ state: authState, uppyVersions: clientVersion })\n\n    const authWindow = window.open(link, '_blank')\n    const handleToken = (e) => {\n      if (e.source !== authWindow) {\n        this.plugin.uppy.log('rejecting event from unknown source')\n        return\n      }\n      if (!isOriginAllowed(e.origin, this.plugin.opts.companionAllowedHosts) || e.source !== authWindow) {\n        this.plugin.uppy.log(`rejecting event from ${e.origin} vs allowed pattern ${this.plugin.opts.companionAllowedHosts}`)\n      }\n\n      // Check if it's a string before doing the JSON.parse to maintain support\n      // for older Companion versions that used object references\n      const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n      if (data.error) {\n        this.plugin.uppy.log('auth aborted', 'warning')\n        const { uppy } = this.plugin\n        const message = uppy.i18n('authAborted')\n        uppy.info({ message }, 'warning', 5000)\n        return\n      }\n\n      if (!data.token) {\n        this.plugin.uppy.log('did not receive token from auth window', 'error')\n        return\n      }\n\n      authWindow.close()\n      window.removeEventListener('message', handleToken)\n      this.provider.setAuthToken(data.token)\n      this.preFirstRender()\n    }\n    window.addEventListener('message', handleToken)\n  }\n\n  async handleScroll (event) {\n    const path = this.nextPagePath || null\n\n    if (this.shouldHandleScroll(event) && path) {\n      this.isHandlingScroll = true\n\n      try {\n        const response = await this.provider.list(path)\n        const { files, folders } = this.plugin.getPluginState()\n\n        this.#updateFilesAndFolders(response, files, folders)\n      } catch (error) {\n        this.handleError(error)\n      } finally {\n        this.isHandlingScroll = false\n      }\n    }\n  }\n\n  async listAllFiles (path, files = null) {\n    files = files || [] // eslint-disable-line no-param-reassign\n    const res = await this.provider.list(path)\n    res.items.forEach((item) => {\n      if (!item.isFolder) {\n        files.push(item)\n      } else {\n        this.addFolder(item)\n      }\n    })\n    const moreFiles = res.nextPagePath\n    if (moreFiles) {\n      return this.listAllFiles(moreFiles, files)\n    }\n    return files\n  }\n\n  donePicking () {\n    const { currentSelection } = this.plugin.getPluginState()\n    const promises = currentSelection.map((file) => {\n      if (file.isFolder) {\n        return this.addFolder(file)\n      }\n      return this.addFile(file)\n    })\n\n    this.sharedHandler.loaderWrapper(Promise.all(promises), () => {\n      this.clearSelection()\n    }, () => {})\n  }\n\n  render (state, viewOptions = {}) {\n    const { authenticated, didFirstRender } = this.plugin.getPluginState()\n\n    if (!didFirstRender) {\n      this.preFirstRender()\n    }\n\n    const targetViewOptions = { ...this.opts, ...viewOptions }\n    const { files, folders, filterInput, loading, currentSelection } = this.plugin.getPluginState()\n    const { isChecked, toggleCheckbox, recordShiftKeyPress, filterItems } = this.sharedHandler\n    const hasInput = filterInput !== ''\n    const headerProps = {\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      getFolder: this.getFolder,\n      directories: this.plugin.getPluginState().directories,\n      pluginIcon: this.plugin.icon,\n      title: this.plugin.title,\n      logout: this.logout,\n      username: this.username,\n      i18n: this.plugin.uppy.i18n,\n    }\n\n    const browserProps = {\n      isChecked,\n      toggleCheckbox,\n      recordShiftKeyPress,\n      currentSelection,\n      files: hasInput ? filterItems(files) : files,\n      folders: hasInput ? filterItems(folders) : folders,\n      username: this.username,\n      getNextFolder: this.getNextFolder,\n      getFolder: this.getFolder,\n      filterItems: this.sharedHandler.filterItems,\n      filterQuery: this.filterQuery,\n      logout: this.logout,\n      handleScroll: this.handleScroll,\n      listAllFiles: this.listAllFiles,\n      done: this.donePicking,\n      cancel: this.cancelPicking,\n      headerComponent: Header(headerProps),\n      title: this.plugin.title,\n      viewType: targetViewOptions.viewType,\n      showTitles: targetViewOptions.showTitles,\n      showFilter: targetViewOptions.showFilter,\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      pluginIcon: this.plugin.icon,\n      i18n: this.plugin.uppy.i18n,\n      uppyFiles: this.plugin.uppy.getFiles(),\n      validateRestrictions: (...args) => this.plugin.uppy.validateRestrictions(...args),\n    }\n\n    if (loading) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <LoaderView i18n={this.plugin.uppy.i18n} />\n        </CloseWrapper>\n      )\n    }\n\n    if (!authenticated) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <AuthView\n            pluginName={this.plugin.title}\n            pluginIcon={this.plugin.icon}\n            handleAuth={this.handleAuth}\n            i18n={this.plugin.uppy.i18n}\n            i18nArray={this.plugin.uppy.i18nArray}\n          />\n        </CloseWrapper>\n      )\n    }\n\n    return (\n      <CloseWrapper onUnmount={this.clearSelection}>\n        {/* eslint-disable-next-line react/jsx-props-no-spreading */}\n        <Browser {...browserProps} />\n      </CloseWrapper>\n    )\n  }\n}\n"],"mappings":"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"}