{"version":3,"names":["UIPlugin","dataURItoBlob","isObjectURL","isPreviewSupported","rotation","locale","packageJson","canvasToBlob","canvas","type","quality","getContext","getImageData","err","code","Promise","reject","Error","toBlob","resolve","then","blob","toDataURL","rotateImage","image","translate","w","width","h","height","deg","document","createElement","context","rotate","rad","scale","scaleX","scaleY","drawImage","protect","ratio","maxSquare","maxSize","maxW","Math","floor","sqrt","maxH","round","ThumbnailGenerator","constructor","uppy","opts","onFileAdded","file","preview","data","isRemote","addToQueue","id","onCancelRequest","index","queue","indexOf","splice","onFileRemoved","URL","revokeObjectURL","onRestored","restoredFiles","getFiles","filter","isRestored","forEach","onAllFilesRemoved","waitUntilAllProcessed","fileIDs","fileID","getFile","emit","mode","message","i18n","emitPreprocessCompleteForAll","queueProcessing","once","title","defaultThumbnailDimension","thumbnailType","defaultLocale","defaultOptions","thumbnailWidth","thumbnailHeight","waitForThumbnailsBeforeUpload","lazy","i18nInit","createThumbnail","targetWidth","targetHeight","originalUrl","createObjectURL","onload","Image","src","addEventListener","event","error","orientationPromise","catch","all","orientation","dimensions","getProportionalDimensions","rotatedImage","resizedImage","resizeImage","img","aspect","steps","ceil","log2","sW","sH","x","setPreviewURL","setFileState","item","push","processQueue","length","current","shift","log","requestThumbnail","install","on","addPreProcessor","uninstall","off","removePreProcessor","VERSION","version"],"sources":["index.js"],"sourcesContent":["import { UIPlugin } from '@uppy/core'\nimport dataURItoBlob from '@uppy/utils/lib/dataURItoBlob'\nimport isObjectURL from '@uppy/utils/lib/isObjectURL'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\nimport { rotation } from 'exifr/dist/mini.esm.mjs'\n\nimport locale from './locale.js'\nimport packageJson from '../package.json'\n\n/**\n * Save a <canvas> element's content to a Blob object.\n *\n * @param {HTMLCanvasElement} canvas\n * @returns {Promise}\n */\nfunction canvasToBlob (canvas, type, quality) {\n  try {\n    canvas.getContext('2d').getImageData(0, 0, 1, 1)\n  } catch (err) {\n    if (err.code === 18) {\n      return Promise.reject(new Error('cannot read image, probably an svg with external resources'))\n    }\n  }\n\n  if (canvas.toBlob) {\n    return new Promise(resolve => {\n      canvas.toBlob(resolve, type, quality)\n    }).then((blob) => {\n      if (blob === null) {\n        throw new Error('cannot read image, probably an svg with external resources')\n      }\n      return blob\n    })\n  }\n  return Promise.resolve().then(() => {\n    return dataURItoBlob(canvas.toDataURL(type, quality), {})\n  }).then((blob) => {\n    if (blob === null) {\n      throw new Error('could not extract blob, probably an old browser')\n    }\n    return blob\n  })\n}\n\nfunction rotateImage (image, translate) {\n  let w = image.width\n  let h = image.height\n\n  if (translate.deg === 90 || translate.deg === 270) {\n    w = image.height\n    h = image.width\n  }\n\n  const canvas = document.createElement('canvas')\n  canvas.width = w\n  canvas.height = h\n\n  const context = canvas.getContext('2d')\n  context.translate(w / 2, h / 2)\n  if (translate.canvas) {\n    context.rotate(translate.rad)\n    context.scale(translate.scaleX, translate.scaleY)\n  }\n  context.drawImage(image, -image.width / 2, -image.height / 2, image.width, image.height)\n\n  return canvas\n}\n\n/**\n * Make sure the image doesnâ€™t exceed browser/device canvas limits.\n * For ios with 256 RAM and ie\n */\nfunction protect (image) {\n  // https://stackoverflow.com/questions/6081483/maximum-size-of-a-canvas-element\n\n  const ratio = image.width / image.height\n\n  const maxSquare = 5000000 // ios max canvas square\n  const maxSize = 4096 // ie max canvas dimensions\n\n  let maxW = Math.floor(Math.sqrt(maxSquare * ratio))\n  let maxH = Math.floor(maxSquare / Math.sqrt(maxSquare * ratio))\n  if (maxW > maxSize) {\n    maxW = maxSize\n    maxH = Math.round(maxW / ratio)\n  }\n  if (maxH > maxSize) {\n    maxH = maxSize\n    maxW = Math.round(ratio * maxH)\n  }\n  if (image.width > maxW) {\n    const canvas = document.createElement('canvas')\n    canvas.width = maxW\n    canvas.height = maxH\n    canvas.getContext('2d').drawImage(image, 0, 0, maxW, maxH)\n    return canvas\n  }\n\n  return image\n}\n\n/**\n * The Thumbnail Generator plugin\n */\n\nexport default class ThumbnailGenerator extends UIPlugin {\n  static VERSION = packageJson.version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'modifier'\n    this.id = this.opts.id || 'ThumbnailGenerator'\n    this.title = 'Thumbnail Generator'\n    this.queue = []\n    this.queueProcessing = false\n    this.defaultThumbnailDimension = 200\n    this.thumbnailType = this.opts.thumbnailType || 'image/jpeg'\n\n    this.defaultLocale = locale\n\n    const defaultOptions = {\n      thumbnailWidth: null,\n      thumbnailHeight: null,\n      waitForThumbnailsBeforeUpload: false,\n      lazy: false,\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n    this.i18nInit()\n\n    if (this.opts.lazy && this.opts.waitForThumbnailsBeforeUpload) {\n      throw new Error('ThumbnailGenerator: The `lazy` and `waitForThumbnailsBeforeUpload` options are mutually exclusive. Please ensure at most one of them is set to `true`.')\n    }\n  }\n\n  /**\n   * Create a thumbnail for the given Uppy file object.\n   *\n   * @param {{data: Blob}} file\n   * @param {number} targetWidth\n   * @param {number} targetHeight\n   * @returns {Promise}\n   */\n  createThumbnail (file, targetWidth, targetHeight) {\n    const originalUrl = URL.createObjectURL(file.data)\n\n    const onload = new Promise((resolve, reject) => {\n      const image = new Image()\n      image.src = originalUrl\n      image.addEventListener('load', () => {\n        URL.revokeObjectURL(originalUrl)\n        resolve(image)\n      })\n      image.addEventListener('error', (event) => {\n        URL.revokeObjectURL(originalUrl)\n        reject(event.error || new Error('Could not create thumbnail'))\n      })\n    })\n\n    const orientationPromise = rotation(file.data).catch(() => 1)\n\n    return Promise.all([onload, orientationPromise])\n      .then(([image, orientation]) => {\n        const dimensions = this.getProportionalDimensions(image, targetWidth, targetHeight, orientation.deg)\n        const rotatedImage = rotateImage(image, orientation)\n        const resizedImage = this.resizeImage(rotatedImage, dimensions.width, dimensions.height)\n        return canvasToBlob(resizedImage, this.thumbnailType, 80)\n      })\n      .then(blob => {\n        return URL.createObjectURL(blob)\n      })\n  }\n\n  /**\n   * Get the new calculated dimensions for the given image and a target width\n   * or height. If both width and height are given, only width is taken into\n   * account. If neither width nor height are given, the default dimension\n   * is used.\n   */\n  getProportionalDimensions (img, width, height, rotation) { // eslint-disable-line no-shadow\n    let aspect = img.width / img.height\n    if (rotation === 90 || rotation === 270) {\n      aspect = img.height / img.width\n    }\n\n    if (width != null) {\n      return {\n        width,\n        height: Math.round(width / aspect),\n      }\n    }\n\n    if (height != null) {\n      return {\n        width: Math.round(height * aspect),\n        height,\n      }\n    }\n\n    return {\n      width: this.defaultThumbnailDimension,\n      height: Math.round(this.defaultThumbnailDimension / aspect),\n    }\n  }\n\n  /**\n   * Resize an image to the target `width` and `height`.\n   *\n   * Returns a Canvas with the resized image on it.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  resizeImage (image, targetWidth, targetHeight) {\n    // Resizing in steps refactored to use a solution from\n    // https://blog.uploadcare.com/image-resize-in-browsers-is-broken-e38eed08df01\n\n    let img = protect(image)\n\n    let steps = Math.ceil(Math.log2(img.width / targetWidth))\n    if (steps < 1) {\n      steps = 1\n    }\n    let sW = targetWidth * 2 ** (steps - 1)\n    let sH = targetHeight * 2 ** (steps - 1)\n    const x = 2\n\n    while (steps--) {\n      const canvas = document.createElement('canvas')\n      canvas.width = sW\n      canvas.height = sH\n      canvas.getContext('2d').drawImage(img, 0, 0, sW, sH)\n      img = canvas\n\n      sW = Math.round(sW / x)\n      sH = Math.round(sH / x)\n    }\n\n    return img\n  }\n\n  /**\n   * Set the preview URL for a file.\n   */\n  setPreviewURL (fileID, preview) {\n    this.uppy.setFileState(fileID, { preview })\n  }\n\n  addToQueue (item) {\n    this.queue.push(item)\n    if (this.queueProcessing === false) {\n      this.processQueue()\n    }\n  }\n\n  processQueue () {\n    this.queueProcessing = true\n    if (this.queue.length > 0) {\n      const current = this.uppy.getFile(this.queue.shift())\n      if (!current) {\n        this.uppy.log('[ThumbnailGenerator] file was removed before a thumbnail could be generated, but not removed from the queue. This is probably a bug', 'error')\n        return Promise.resolve()\n      }\n      return this.requestThumbnail(current)\n        .catch(() => {}) // eslint-disable-line node/handle-callback-err\n        .then(() => this.processQueue())\n    }\n    this.queueProcessing = false\n    this.uppy.log('[ThumbnailGenerator] Emptied thumbnail queue')\n    this.uppy.emit('thumbnail:all-generated')\n    return Promise.resolve()\n  }\n\n  requestThumbnail (file) {\n    if (isPreviewSupported(file.type) && !file.isRemote) {\n      return this.createThumbnail(file, this.opts.thumbnailWidth, this.opts.thumbnailHeight)\n        .then(preview => {\n          this.setPreviewURL(file.id, preview)\n          this.uppy.log(`[ThumbnailGenerator] Generated thumbnail for ${file.id}`)\n          this.uppy.emit('thumbnail:generated', this.uppy.getFile(file.id), preview)\n        })\n        .catch(err => {\n          this.uppy.log(`[ThumbnailGenerator] Failed thumbnail for ${file.id}:`, 'warning')\n          this.uppy.log(err, 'warning')\n          this.uppy.emit('thumbnail:error', this.uppy.getFile(file.id), err)\n        })\n    }\n    return Promise.resolve()\n  }\n\n  onFileAdded = (file) => {\n    if (\n      !file.preview\n      && file.data\n      && isPreviewSupported(file.type)\n      && !file.isRemote\n    ) {\n      this.addToQueue(file.id)\n    }\n  }\n\n  /**\n   * Cancel a lazy request for a thumbnail if the thumbnail has not yet been generated.\n   */\n  onCancelRequest = (file) => {\n    const index = this.queue.indexOf(file.id)\n    if (index !== -1) {\n      this.queue.splice(index, 1)\n    }\n  }\n\n  /**\n   * Clean up the thumbnail for a file. Cancel lazy requests and free the thumbnail URL.\n   */\n  onFileRemoved = (file) => {\n    const index = this.queue.indexOf(file.id)\n    if (index !== -1) {\n      this.queue.splice(index, 1)\n    }\n\n    // Clean up object URLs.\n    if (file.preview && isObjectURL(file.preview)) {\n      URL.revokeObjectURL(file.preview)\n    }\n  }\n\n  onRestored = () => {\n    const restoredFiles = this.uppy.getFiles().filter(file => file.isRestored)\n    restoredFiles.forEach((file) => {\n      // Only add blob URLs; they are likely invalid after being restored.\n      if (!file.preview || isObjectURL(file.preview)) {\n        this.addToQueue(file.id)\n      }\n    })\n  }\n\n  onAllFilesRemoved = () => {\n    this.queue = []\n  }\n\n  waitUntilAllProcessed = (fileIDs) => {\n    fileIDs.forEach((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('generatingThumbnails'),\n      })\n    })\n\n    const emitPreprocessCompleteForAll = () => {\n      fileIDs.forEach((fileID) => {\n        const file = this.uppy.getFile(fileID)\n        this.uppy.emit('preprocess-complete', file)\n      })\n    }\n\n    return new Promise((resolve) => {\n      if (this.queueProcessing) {\n        this.uppy.once('thumbnail:all-generated', () => {\n          emitPreprocessCompleteForAll()\n          resolve()\n        })\n      } else {\n        emitPreprocessCompleteForAll()\n        resolve()\n      }\n    })\n  }\n\n  install () {\n    this.uppy.on('file-removed', this.onFileRemoved)\n    this.uppy.on('cancel-all', this.onAllFilesRemoved)\n\n    if (this.opts.lazy) {\n      this.uppy.on('thumbnail:request', this.onFileAdded)\n      this.uppy.on('thumbnail:cancel', this.onCancelRequest)\n    } else {\n      this.uppy.on('file-added', this.onFileAdded)\n      this.uppy.on('restored', this.onRestored)\n    }\n\n    if (this.opts.waitForThumbnailsBeforeUpload) {\n      this.uppy.addPreProcessor(this.waitUntilAllProcessed)\n    }\n  }\n\n  uninstall () {\n    this.uppy.off('file-removed', this.onFileRemoved)\n    this.uppy.off('cancel-all', this.onAllFilesRemoved)\n\n    if (this.opts.lazy) {\n      this.uppy.off('thumbnail:request', this.onFileAdded)\n      this.uppy.off('thumbnail:cancel', this.onCancelRequest)\n    } else {\n      this.uppy.off('file-added', this.onFileAdded)\n      this.uppy.off('restored', this.onRestored)\n    }\n\n    if (this.opts.waitForThumbnailsBeforeUpload) {\n      this.uppy.removePreProcessor(this.waitUntilAllProcessed)\n    }\n  }\n}\n"],"mappings":"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"}